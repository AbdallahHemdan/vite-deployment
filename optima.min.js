!(function(){"use strict";function e(){const e=navigator.userAgent;return/(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(e)?"tablet":/Mobile|Android|iP(hone|od)|IEMobile|BlackBerry|Kindle|Silk-Accelerated|(hpw|web)OS|Opera M(obi|ini)/.test(e)?"mobile":"desktop"}function t(e){try{"PerformanceObserver"in window&&((function(e){let t=0;new PerformanceObserver((n=>{const i=n.getEntries(),a=i[i.length-1];if(window.performance.mark("optima_lcp"),window.performance.measure("optima_lcp_time","navigationStart","optima_lcp"),a.startTime>t){t=a.startTime;const n=a.element?{tagName:a.element.tagName,id:a.element.id||null,className:a.element.className||null,size:a.size,dimensions:a.element.getBoundingClientRect?{width:Math.round(a.element.getBoundingClientRect().width),height:Math.round(a.element.getBoundingClientRect().height)}:null}:"unknown";e.sendEvent("core_web_vital",{name:"LCP",value:a.startTime,element:n}),e.unifiedDataModel.web_vitals.LCP={value:a.startTime,timestamp:performance.timeOrigin+a.startTime,element:n},i.length>1||setTimeout((()=>{e.buffer.webVitals.length>0&&e._updateWebVitalsInUnifiedModel()}),1e3)}})).observe({type:"largest-contentful-paint",buffered:!0})})(e),(function(e){new PerformanceObserver((t=>{const n=t.getEntries()[0];window.performance.mark("optima_fid");const i={type:n.name,targetElement:n.target?{tagName:n.target.tagName,id:n.target.id||null,className:n.target.className||null}:null,timing:{processingStart:n.processingStart,processingEnd:n.processingEnd,startTime:n.startTime}},a=n.processingStart-n.startTime;e.sendEvent("core_web_vital",{name:"FID",value:a,inputType:n.name,details:i},{immediate:!0}),e.unifiedDataModel.web_vitals.FID={value:a,timestamp:performance.timeOrigin+n.startTime,inputType:n.name,details:i}})).observe({type:"first-input",buffered:!0})})(e),(function(e){let t=0,n=[],i=[],a=0,s=performance.now(),o=0;document.addEventListener("visibilitychange",(()=>{"hidden"===document.visibilityState?o>0&&(e.unifiedDataModel.web_vitals.CLS={value:o,timestamp:Date.now(),entries:i.length}):"visible"===document.visibilityState&&performance.now()-s>1e3&&(s=performance.now(),o=0,i=[])}));new PerformanceObserver((s=>{s.getEntries().forEach((e=>{e.hadRecentInput||(t+=e.value,n.push(e),o+=e.value,i.push({value:e.value,startTime:e.startTime}))}));const r=Date.now();(r-a>5e3||n.length%10==0)&&n.length>0&&(a=r,e.sendEvent("core_web_vital",{name:"CLS",value:t,entries:n.length,sessionValue:o,sessionEntries:i.length}),e.unifiedDataModel.web_vitals.CLS={value:t,timestamp:r,entries:n.length,sessionValue:o,sessionEntries:i.length},n.length%30==0&&setTimeout((()=>{e.buffer.webVitals.length>0&&e._updateWebVitalsInUnifiedModel()}),1e3))})).observe({type:"layout-shift",buffered:!0})})(e),(function(e){if(!window.PerformanceObserver||!window.PerformanceObserver.supportedEntryTypes||!window.PerformanceObserver.supportedEntryTypes.includes("event"))return;let t=0;const n=new PerformanceObserver((n=>{n.getEntries().forEach((n=>{if(!["pointerdown","keydown","click","mousedown","touchstart"].includes(n.name))return;const i=n.processingEnd-n.startTime,a={name:n.name,startTime:n.startTime,processingStart:n.processingStart,processingEnd:n.processingEnd,duration:i,renderTime:n.renderTime||null,interactionId:n.interactionId||null,targetElement:n.target?{tagName:n.target.tagName,id:n.target.id||null,className:n.target.className||null}:null};i>t&&(t=i,e.sendEvent("core_web_vital",{name:"INP",value:i,interaction:a}),e.unifiedDataModel.web_vitals.INP={value:i,timestamp:performance.timeOrigin+n.startTime,interaction:a})}))}));try{n.observe({type:"event",buffered:!0,durationThreshold:16})}catch(e){}})(e),(function(e){document.addEventListener("visibilitychange",(function(){"hidden"===document.visibilityState&&e.buffer.webVitals.length>0&&e._prepareFinalDataAndSend(!0)})),window.addEventListener("beforeunload",(function(){e.buffer.webVitals.length>0&&e._prepareFinalDataAndSend(!0)}))})(e),(function(e){if(!window.PerformanceObserver||!window.PerformanceObserver.supportedEntryTypes||!window.PerformanceObserver.supportedEntryTypes.includes("longtask"))return;let t=[];const n=new PerformanceObserver((n=>{n.getEntries().forEach((e=>{t.push({startTime:e.startTime,duration:e.duration,attribution:e.attribution?.length?{name:e.attribution[0].name,containerType:e.attribution[0].containerType,containerName:e.attribution[0].containerName,containerId:e.attribution[0].containerId}:null})})),5>t.length||(e.unifiedDataModel.metrics.longTasks=t,t=[])}));try{n.observe({type:"longtask",buffered:!0})}catch(e){}})(e))}catch(e){}}function n(e){if(!e.sessionId)return;"complete"===document.readyState?e.collectionState.pageLoaded||(e.collectionState.pageLoaded=!0,setTimeout((()=>{e.captureResourceData("load"),e.sendEvent("page_view",{url:window.location.href,title:document.title,referrer:document.referrer})}),1e3)):window.addEventListener("load",(()=>{e.collectionState.pageLoaded||(e.collectionState.pageLoaded=!0,setTimeout((()=>{e.captureResourceData("load"),e.sendEvent("page_view",{url:window.location.href,title:document.title,referrer:document.referrer})}),1e3))}));let t=null;if(document.addEventListener("click",(n=>{let i=n.target,a="";if("A"===i.tagName||i.closest("a")){const t="A"===i.tagName?i:i.closest("a");a="link",e.sendEvent("user_interaction",{type:"click",element_type:a,element_id:t.id||null,element_class:t.className||null,element_text:t.textContent?.trim()||null,element_href:t.href||null})}else if("BUTTON"===i.tagName||i.closest("button")){const t="BUTTON"===i.tagName?i:i.closest("button");a="button",e.sendEvent("user_interaction",{type:"click",element_type:a,element_id:t.id||null,element_class:t.className||null,element_text:t.textContent?.trim()||null})}t&&clearTimeout(t),t=setTimeout((()=>{e.captureResourceData("interaction"),t=null}),2e3)})),"requestIdleCallback"in window){let t=!1;window.requestIdleCallback((()=>{t||(t=!0,e.captureResourceData("idle"),e.sendEvent("page_ready",{url:window.location.href,title:document.title,time_to_idle:performance.now()}))}),{timeout:3e3})}document.addEventListener("visibilitychange",(()=>{"visible"===document.visibilityState?e.sendEvent("visibility_change",{state:"visible",timestamp:Date.now()}):"hidden"===document.visibilityState&&e.sendEvent("visibility_change",{state:"hidden",timestamp:Date.now()},{immediate:!0})}))}function i(e){e.buffer.ajaxCalls||(e.buffer.ajaxCalls=[]),e.buffer.preSessionAjaxCalls||(e.buffer.preSessionAjaxCalls=[]),(function(e){const t=XMLHttpRequest.prototype.open,n=XMLHttpRequest.prototype.send;function i(e,t){if(e._optimaData&&!(e._optimaData.url.includes("/api/sessions")||e._optimaData.url.includes("/api/events")||e._optimaData.url.includes("/api/resources")||e._optimaData.url.includes("/api/web-vitals")||e._optimaData.url.includes("/api/ajax-calls"))){e._optimaData.duration=Date.now()-e._optimaData.startTime,e._optimaData.errored||e._optimaData.aborted||(e._optimaData.status=e.status,e._optimaData.statusText=e.statusText);try{const t=e.getAllResponseHeaders();t&&t.trim().split(/[\r\n]+/).forEach((t=>{const n=t.split(": "),i=n.shift(),a=n.join(": ");e._optimaData.responseHeaders[i.toLowerCase()]=a}))}catch(e){}if(""===e.responseType||"text"===e.responseType)e._optimaData.responseSize=e.responseText?e.responseText.length:0;else if("blob"===e.responseType)e._optimaData.responseSize=e.response?e.response.size:0;else if("arraybuffer"===e.responseType)e._optimaData.responseSize=e.response?e.response.byteLength:0;else if("json"===e.responseType)try{e._optimaData.responseSize=e.response?JSON.stringify(e.response).length:0}catch(t){e._optimaData.responseSize=-1}else e._optimaData.responseSize=-1;if(window.performance&&window.performance.getEntriesByType){const t=window.performance.getEntriesByType("resource"),n=e._optimaData.url.split("?")[0],i=t.find((e=>e.name.indexOf(n)>=0&&("xmlhttprequest"===e.initiatorType||"fetch"===e.initiatorType)));i&&(e._optimaData.resourceTiming={startTime:Math.round(i.startTime),duration:Math.round(i.duration),domainLookupTime:Math.round(i.domainLookupEnd-i.domainLookupStart),connectTime:Math.round(i.connectEnd-i.connectStart),tlsTime:i.secureConnectionStart?Math.round(i.connectEnd-i.secureConnectionStart):0,requestStartTime:Math.round(i.requestStart),ttfb:Math.round(i.responseStart-i.requestStart),downloadTime:Math.round(i.responseEnd-i.responseStart)})}a(t,{type:"xhr",method:e._optimaData.method,url:e._optimaData.url,status:e._optimaData.status,statusText:e._optimaData.statusText,startTime:e._optimaData.startTime,duration:e._optimaData.duration,async:e._optimaData.async,requestPayloadSize:e._optimaData.requestPayloadSize,responseSize:e._optimaData.responseSize,aborted:e._optimaData.aborted,errored:e._optimaData.errored,timedOut:e._optimaData.timedOut,timestamp:Date.now(),resourceTiming:e._optimaData.resourceTiming||null,requestHeaders:{"content-type":e._optimaData.sentHeaders["content-type"]||"unknown","content-length":e._optimaData.sentHeaders["content-length"]||"unknown"},responseHeaders:{"content-type":e._optimaData.responseHeaders["content-type"]||"unknown","content-length":e._optimaData.responseHeaders["content-length"]||"unknown","cache-control":e._optimaData.responseHeaders["cache-control"]||"unknown"}})}}XMLHttpRequest.prototype.open=function(e,n,i,a,s){return this._optimaData={method:e,url:n,startTime:Date.now(),async:!1!==i,status:0,statusText:"",sentHeaders:{},responseHeaders:{},responseSize:0,duration:0,aborted:!1,errored:!1},t.apply(this,arguments)},XMLHttpRequest.prototype.send=function(t){if(this._optimaData||(this._optimaData={method:"unknown",url:"unknown",startTime:Date.now(),async:!0,status:0,statusText:"",sentHeaders:{},responseHeaders:{},responseSize:0,duration:0,aborted:!1,errored:!1}),t)try{this._optimaData.requestPayloadSize="string"==typeof t?t.length:t instanceof FormData?-1:t instanceof Blob?t.size:t instanceof ArrayBuffer?t.byteLength:JSON.stringify(t).length}catch(e){this._optimaData.requestPayloadSize=-1}else this._optimaData.requestPayloadSize=0;try{if(this.getAllRequestHeaders){const e=this.getAllRequestHeaders();e&&e.trim().split(/[\r\n]+/).forEach((e=>{const t=e.split(": "),n=t.shift(),i=t.join(": ");this._optimaData.sentHeaders[n.toLowerCase()]=i}))}}catch(e){}const a=this;return a.addEventListener("load",(function(){i(a,e)})),a.addEventListener("error",(function(){a._optimaData.errored=!0,a._optimaData.status=0,a._optimaData.statusText="Network Error",i(a,e)})),a.addEventListener("abort",(function(){a._optimaData.aborted=!0,i(a,e)})),a.addEventListener("timeout",(function(){a._optimaData.timedOut=!0,i(a,e)})),n.apply(this,arguments)}})(e),(function(e){if("function"!=typeof window.fetch)return;const t=window.fetch;window.fetch=function(n,i){const s=Date.now()+Math.random().toString(36).substring(2,9);let o,r,l={};if("string"==typeof n?o=n:n instanceof Request&&(o=n.url,r=n.method),i&&(r=i.method||"GET",i.headers))if(i.headers instanceof Headers)try{for(let e of i.headers.entries())l[e[0].toLowerCase()]=e[1]}catch(e){}else"object"==typeof i.headers&&Object.keys(i.headers).forEach((e=>{l[e.toLowerCase()]=i.headers[e]}));if(r=r||"GET",o.includes("/api/sessions")||o.includes("/api/events")||o.includes("/api/resources")||o.includes("/api/web-vitals")||o.includes("/api/ajax-calls"))return t.apply(this,arguments);const c=Date.now(),u={type:"fetch",id:s,method:r,url:o,status:0,statusText:"",startTime:c,duration:0,requestPayloadSize:-1,responseSize:-1,aborted:!1,errored:!1,timestamp:c,resourceTiming:null,requestHeaders:{"content-type":l["content-type"]||"unknown","content-length":l["content-length"]||"unknown"},responseHeaders:{}};if(i&&i.body)try{u.requestPayloadSize="string"==typeof i.body?i.body.length:i.body instanceof FormData?-1:i.body instanceof Blob?i.body.size:i.body instanceof ArrayBuffer?i.body.byteLength:JSON.stringify(i.body).length}catch(e){u.requestPayloadSize=-1}const d=t.apply(this,arguments);return d.then((t=>{const n=Date.now();u.duration=n-c,u.status=t.status,u.statusText=t.statusText;try{t.headers&&(u.responseHeaders={"content-type":t.headers.get("content-type")||"unknown","content-length":t.headers.get("content-length")||"unknown","cache-control":t.headers.get("cache-control")||"unknown"})}catch(e){}const i=t.headers.get("content-length");return i&&(u.responseSize=parseInt(i,10)),t.clone().text().then((t=>{if(0>u.responseSize&&(u.responseSize=t.length),window.performance&&window.performance.getEntriesByType){const e=window.performance.getEntriesByType("resource"),t=u.url.split("?")[0],n=e.find((e=>e.name.indexOf(t)>=0&&("fetch"===e.initiatorType||"xmlhttprequest"===e.initiatorType)));n&&(u.resourceTiming={startTime:Math.round(n.startTime),duration:Math.round(n.duration),domainLookupTime:Math.round(n.domainLookupEnd-n.domainLookupStart),connectTime:Math.round(n.connectEnd-n.connectStart),tlsTime:n.secureConnectionStart?Math.round(n.connectEnd-n.secureConnectionStart):0,requestStartTime:Math.round(n.requestStart),ttfb:Math.round(n.responseStart-n.requestStart),downloadTime:Math.round(n.responseEnd-n.responseStart)})}a(e,u)})).catch((e=>{}))})).catch((t=>{const n=Date.now();u.duration=n-c,u.errored=!0,u.errorMessage=t.message||"Network error",a(e,u)})),d}})(e)}function a(e,t){e.sessionId?(e.buffer.ajaxCalls.push(t),e.batchConfig.maxAjaxCallsPerBatch>e.buffer.ajaxCalls.length||e._flushAjaxCalls()):e.buffer.preSessionAjaxCalls.push(t)}function s(e){return{setupBufferManagement:function(){setInterval((()=>{this.trimBuffers()}),3e4)},trimBuffers:function(){const t=e.batchConfig.maxBufferSize;e.buffer.events.length>t&&(e.buffer.events=e.buffer.events.slice(-t)),e.buffer.resources.length>t&&(e.buffer.resources=e.buffer.resources.slice(-t)),e.buffer.webVitals.length>t&&(e.buffer.webVitals=e.buffer.webVitals.slice(-t))},hashResource:function(e){return`${e.type}|${e.name.split("?")[0]}|${50>e.duration?"fast":"slow"}`},shouldCollectResource:function(t){if(e.batchConfig.resourceDedupingEnabled){const n=this.hashResource(t);if(e.collectionState.resourceHashMap[n])return!1;e.collectionState.resourceHashMap[n]=Date.now()}return!0},startBatchProcessing:function(){if(setInterval((()=>{e.buffer.events.length>0&&e._flushEvents(),e.buffer.webVitals.length>0&&e._flushWebVitals(),e.buffer.resources.length>0&&e._flushResources()}),Math.min(e.batchConfig.flushInterval,1e4)),e.batchConfig.visibilityFlushEnabled&&document.addEventListener("visibilitychange",(()=>{const t=Date.now(),n=document.visibilityState;e.collectionState.visibilityState=n,t-e.collectionState.lastVisibilityChange>1e3&&(e.collectionState.lastVisibilityChange=t,"hidden"===n?e._flushBuffers("visibilityHidden",!0):"visible"===n&&setTimeout((()=>{e.captureResourceData("visibilityVisible")}),1e3))})),window.addEventListener("beforeunload",(()=>{e._flushBuffers("unload",!0)})),e.batchConfig.flushAtIdle&&"requestIdleCallback"in window){const t=()=>{window.requestIdleCallback((()=>{(e.buffer.events.length>=10||e.buffer.resources.length>=10||Date.now()-e.collectionState.lastResourceFlush>3e4)&&e._flushBuffers("idle"),setTimeout((()=>{t()}),2e4)}),{timeout:1e4})};t()}this.setupBufferManagement()}}}function o(t){const n=Date.now().toString(36);t.sessionId=`${n}-${"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))}`;const i=window.performance&&window.performance.timing?window.performance.timing:{},a={session_id:t.sessionId,page_url:window.location.href,navigation_start:i.navigationStart||Date.now(),timestamp:Date.now(),user_agent:navigator.userAgent,device_type:e(),connection_type:navigator.connection&&navigator.connection.effectiveType||"unknown",referrer:document.referrer||"",resources:[],meta:{pathname:window.location.pathname,page_title:document.title,navigation_type:window.performance&&window.performance.getEntriesByType&&window.performance.getEntriesByType("navigation")[0]?.type||"unknown",screen_width:window.screen.width,screen_height:window.screen.height,device_speed:navigator.hardwareConcurrency||null,browser:(()=>{const e=navigator.userAgent;return/chrome|crios|crmo/i.test(e)?"Chrome":/firefox|fxios/i.test(e)?"Firefox":/safari/i.test(e)&&!/chrome|crios|crmo/i.test(e)?"Safari":/edg/i.test(e)?"Edge":/opr\//i.test(e)?"Opera":"Unknown"})(),os:(()=>{const e=navigator.userAgent;return/windows nt/i.test(e)?"Windows":/mac os x/i.test(e)?"Mac OS":/android/i.test(e)?"Android":/iphone|ipad|ipod/i.test(e)?"iOS":/linux/i.test(e)?"Linux":"Unknown"})(),connection_downlink:navigator.connection?.downlink||null,connection_rtt:navigator.connection?.rtt||null}};return(function(e){e.buffer.preSessionAjaxCalls&&e.buffer.preSessionAjaxCalls.length&&(e.buffer.ajaxCalls.push(...e.buffer.preSessionAjaxCalls),e.buffer.preSessionAjaxCalls=[])})(t),t._sendToServer("/api/sessions",a).then((e=>{e&&(t._setupEventListeners(),t._setupPerformanceObservers(),t._startBatchProcessing(),t.sessionStartTime=Date.now(),t.unifiedDataModel.session_id=t.sessionId,t.unifiedDataModel.timestamp=t.sessionStartTime)})),t.sessionId}!(function(e){function a(e){var t;this.apiKey=(e=e||{}).apiKey,this.endpoint=e.endpoint||"http://localhost:3000",this.sessionId=null,this.sessionStartTime=null,this.buffer={events:[],resources:[],webVitals:[],ajaxCalls:[]},this.unifiedDataModel={session_id:null,timestamp:null,web_vitals:{LCP:null,FID:null,CLS:null,TTFB:null,INP:null},resources:[],ajax_requests:[],errors:[],timings:null,metrics:{},meta:{}},this.batchConfig={maxEventsPerBatch:50,maxResourcesPerBatch:50,maxWebVitalsPerBatch:20,maxAjaxCallsPerBatch:50,flushInterval:e.flushInterval||5e3,webVitalsBatchDelay:e.webVitalsBatchDelay||2e3,batchBeforeSend:e.batchBeforeSend||!0,payloadCompressionThreshold:10240},this.collectionState={isFirstLoad:!0,resourcesCollected:!1,lastResourceFlush:null,lastEventFlush:null,lastAjaxCallFlush:null,isPerformanceObserverSet:!1,isBatchProcessingStarted:!1,unloadSent:!1,visibilityChangeCount:0},this.bufferManager=s(this),this.flushManager=(t=this,{flushBuffers:function(e,n=!1){t.buffer.events.length>0&&this.flushEvents(n),t.buffer.resources.length>0&&this.flushResources(n),t.buffer.webVitals.length>0&&this.flushWebVitals(n),t.buffer.ajaxCalls&&t.buffer.ajaxCalls.length>0&&this.flushAjaxCalls(n)},flushEvents:function(e=!1){if(0===t.buffer.events.length)return;const n=t.buffer.events.slice(0,t.batchConfig.maxEventsPerBatch);t.buffer.events=t.buffer.events.slice(t.batchConfig.maxEventsPerBatch);const i={session_id:t.sessionId,events:n,timestamp:Date.now(),count:n.length};t.collectionState.lastEventFlush=Date.now(),t._sendToServer("/api/events",i,{sync:e})},flushResources:function(e=!1){if(0===t.buffer.resources.length)return;const n=t.buffer.resources.slice(0,t.batchConfig.maxResourcesPerBatch);t.buffer.resources=t.buffer.resources.slice(t.batchConfig.maxResourcesPerBatch);const i={session_id:t.sessionId,resources:n,timestamp:Date.now(),count:n.length};t.collectionState.lastResourceFlush=Date.now(),t._sendToServer("/api/resources",i,{sync:e})},flushWebVitals:function(e=!1){if(0===t.buffer.webVitals.length)return;const n=t.buffer.webVitals.slice(0,t.batchConfig.maxWebVitalsPerBatch);t.buffer.webVitals=t.buffer.webVitals.slice(t.batchConfig.maxWebVitalsPerBatch);const i=n.reduce(((e,t)=>{if(!t.event_data||!t.event_data.name)return e;const n=t.event_data.name,i=t.event_data.value;return e[n]=e[n]||[],e[n].push({value:i,timestamp:t.timestamp,...t.event_data}),e}),{}),a={session_id:t.sessionId,web_vitals:n,processed_vitals:i,timestamp:Date.now(),count:n.length},s=e||"hidden"===document.visibilityState;t._sendToServer("/api/web-vitals",a,{sync:s}),t.batchConfig.maxWebVitalsPerBatch/2>t.buffer.webVitals.length||setTimeout((()=>{this.flushWebVitals(e)}),1e3)},flushAjaxCalls:function(e=!1){if(!t.buffer.ajaxCalls||0===t.buffer.ajaxCalls.length)return;const n=t.buffer.ajaxCalls.slice(0,t.batchConfig.maxAjaxCallsPerBatch);t.buffer.ajaxCalls=t.buffer.ajaxCalls.slice(t.batchConfig.maxAjaxCallsPerBatch);const i={session_id:t.sessionId,ajax_calls:n,timestamp:Date.now(),count:n.length};t.collectionState.lastAjaxCallFlush=Date.now(),t._sendToServer("/api/ajax-calls",i,{sync:e})}}),this._setupBatchedCollection(),this._webVitalsBatchTimer=null,this._init()}function r(){var t=Array.prototype.slice.call(arguments),n=t[0];if("init"===n){var i=t[2]||{};return i.apiKey=t[1]||null,e.optimaInstance=new a(i),e.optimaInstance}if(!e.optimaInstance)return!1;switch(n){case"event":return e.optimaInstance.sendEvent(t[1],t[2],t[3]);case"captureResources":return e.optimaInstance.captureResourceData("manual");case"flushBuffers":return e.optimaInstance.sendCollectedData(!0===t[1]);case"debug":return e.optimaInstance.debug();default:return!1}}if(a.prototype={_init:function(){this.apiKey&&(this._initPerformanceMetrics(),this._setupAjaxMonitoring(),this.createSession(),this._setupPageLifecycleEvents())},_initPerformanceMetrics:function(){if(e.performance&&e.performance.mark){e.performance.mark("optima_init");try{e.performance.getEntriesByType("mark").concat(e.performance.getEntriesByType("measure")).filter((e=>e.name.startsWith("optima_"))).forEach((t=>{e.performance.clearMarks(t.name),"measure"===t.entryType&&e.performance.clearMeasures(t.name)}))}catch(e){}this._setupCoreWebVitals(),this._captureNavigationTiming()}},_captureNavigationTiming:function(){try{const e=performance.getEntriesByType("navigation")[0];e&&(this.unifiedDataModel.timings={navigationStart:0,fetchStart:e.fetchStart,domainLookupStart:e.domainLookupStart,domainLookupEnd:e.domainLookupEnd,connectStart:e.connectStart,connectEnd:e.connectEnd,requestStart:e.requestStart,responseStart:e.responseStart,responseEnd:e.responseEnd,domInteractive:e.domInteractive,domContentLoadedEventStart:e.domContentLoadedEventStart,domContentLoadedEventEnd:e.domContentLoadedEventEnd,domComplete:e.domComplete,loadEventStart:e.loadEventStart,loadEventEnd:e.loadEventEnd,duration:e.duration,type:e.type,redirectCount:e.redirectCount,nextHopProtocol:e.nextHopProtocol},this.unifiedDataModel.web_vitals.TTFB={value:e.responseStart,timestamp:performance.timeOrigin+e.responseStart},this.sendEvent("core_web_vital",{name:"TTFB",value:e.responseStart},{immediate:!0}))}catch(e){}},_setupPageLifecycleEvents:function(){document.addEventListener("visibilitychange",(()=>{this.collectionState.visibilityChangeCount++,"hidden"===document.visibilityState?this._prepareFinalDataAndSend(!0):"visible"===document.visibilityState&&this._refreshVisibleState()})),e.addEventListener("beforeunload",(()=>{this.collectionState.unloadSent||(this._prepareFinalDataAndSend(!0),this.collectionState.unloadSent=!0)})),this._setupPeriodicFlush()},_prepareFinalDataAndSend:function(e=!1){this._consolidateBufferedData(),this._updateWebVitalsInUnifiedModel(),this._sendUnifiedData(e)},_updateWebVitalsInUnifiedModel:function(){this.buffer.webVitals.forEach((e=>{if(!e.event_data||!e.event_data.name)return;const{name:t,value:n}=e.event_data,i=e.timestamp;"LCP"===t?this.unifiedDataModel.web_vitals.LCP&&this.unifiedDataModel.web_vitals.LCP.value>=n||(this.unifiedDataModel.web_vitals.LCP={value:n,timestamp:i,element:e.event_data.element||"unknown"}):"FID"===t?this.unifiedDataModel.web_vitals.FID||(this.unifiedDataModel.web_vitals.FID={value:n,timestamp:i,inputType:e.event_data.inputType}):"CLS"===t?this.unifiedDataModel.web_vitals.CLS&&this.unifiedDataModel.web_vitals.CLS.value>=n||(this.unifiedDataModel.web_vitals.CLS={value:n,timestamp:i,entries:e.event_data.entries}):"INP"===t&&(this.unifiedDataModel.web_vitals.INP&&this.unifiedDataModel.web_vitals.INP.value>=n||(this.unifiedDataModel.web_vitals.INP={value:n,timestamp:i,event:e.event_data.event}))})),this.buffer.webVitals=[]},_consolidateBufferedData:function(){this.buffer.resources.length>0&&(this.unifiedDataModel.resources=[...this.unifiedDataModel.resources,...this.buffer.resources],this.buffer.resources=[]),this.buffer.ajaxCalls.length>0&&(this.unifiedDataModel.ajax_requests=[...this.unifiedDataModel.ajax_requests,...this.buffer.ajaxCalls],this.buffer.ajaxCalls=[]),this.buffer.events=[],this.unifiedDataModel.session_id=this.sessionId,this.unifiedDataModel.timestamp=Date.now(),this._updateMetadata()},_updateMetadata:function(){this.unifiedDataModel.meta={url:e.location.href,path:e.location.pathname,referrer:document.referrer,title:document.title,user_agent:navigator.userAgent,screen_width:e.screen.width,screen_height:e.screen.height,viewport_width:e.innerWidth,viewport_height:e.innerHeight,connection_type:navigator.connection?navigator.connection.effectiveType:null,connection_downlink:navigator.connection?navigator.connection.downlink:null,connection_rtt:navigator.connection?navigator.connection.rtt:null,device_memory:navigator.deviceMemory,device_speed:navigator.hardwareConcurrency,page_visibility:document.visibilityState,visibility_changes:this.collectionState.visibilityChangeCount,timestamp:Date.now(),browser:this._detectBrowser(),os:this._detectOS(),navigation_type:performance.getEntriesByType("navigation")[0]?.type||null}},_sendUnifiedData:function(e=!1){if(!this.unifiedDataModel.session_id)return;const t=JSON.parse(JSON.stringify(this.unifiedDataModel));this._sendToServer("/api/collect",t,{sync:e}),this._resetVolatileDataInUnifiedModel()},_resetVolatileDataInUnifiedModel:function(){this.unifiedDataModel.resources=[],this.unifiedDataModel.ajax_requests=[]},_setupBatchedCollection:function(){this.collectionState.isBatchProcessingStarted||(this.collectionState.isBatchProcessingStarted=!0,this._startBatchedCollection())},_startBatchedCollection:function(){setInterval((()=>{this._collectResources()}),3e3),this._setupPeriodicFlush()},_setupPeriodicFlush:function(){setInterval((()=>{this._hasSignificantData()&&this._prepareFinalDataAndSend(!1)}),this.batchConfig.flushInterval)},_hasSignificantData:function(){return this.unifiedDataModel.resources.length>0||this.unifiedDataModel.ajax_requests.length>0||this.buffer.webVitals.length>0||this.unifiedDataModel.web_vitals.LCP&&this.unifiedDataModel.web_vitals.LCP.value||this.unifiedDataModel.web_vitals.FID&&this.unifiedDataModel.web_vitals.FID.value||this.unifiedDataModel.web_vitals.CLS&&this.unifiedDataModel.web_vitals.CLS.value},_collectResources:function(){try{performance.getEntriesByType("resource").forEach((e=>{if(this._isResourceProcessed(e.name))return;const t={name:e.name,type:this._getResourceType(e),startTime:Math.round(e.startTime),duration:Math.round(e.duration),size:e.transferSize||0,protocol:e.nextHopProtocol,encodedSize:e.encodedBodySize||0,decodedSize:e.decodedBodySize||0,initiatorType:e.initiatorType};this.unifiedDataModel.resources.push(t)})),this.collectionState.resourcesCollected=!0}catch(e){}},_isResourceProcessed:function(e){return this.unifiedDataModel.resources.some((t=>t.name===e))},_getResourceType:function(e){const t=e.initiatorType,n=e.name;return"img"===t||"image"===t?"image":"script"===t?"script":"link"===t&&e.nextHopProtocol||"css"===t?"stylesheet":"fetch"===t||"xmlhttprequest"===t?"xhr":/\.(?:png|jpg|jpeg|gif|webp|svg|ico)(?:\?|$)/i.test(n)?"image":/\.(?:js)(?:\?|$)/i.test(n)?"script":/\.(?:css)(?:\?|$)/i.test(n)?"stylesheet":/\.(?:woff2?|ttf|otf|eot)(?:\?|$)/i.test(n)?"font":/\.(?:mp4|webm|ogv)(?:\?|$)/i.test(n)?"video":/\.(?:mp3|ogg|wav)(?:\?|$)/i.test(n)?"audio":"other"},_detectBrowser:function(){const e=navigator.userAgent;return e.indexOf("Chrome")>-1?"Chrome":e.indexOf("Safari")>-1?"Safari":e.indexOf("Firefox")>-1?"Firefox":e.indexOf("MSIE")>-1||e.indexOf("Trident/")>-1?"IE":e.indexOf("Edge")>-1?"Edge":e.indexOf("Opera")>-1||e.indexOf("OPR/")>-1?"Opera":"Unknown"},_detectOS:function(){const e=navigator.userAgent;return e.indexOf("Win")>-1?"Windows":e.indexOf("Mac")>-1?"Mac OS":e.indexOf("Linux")>-1?"Linux":e.indexOf("Android")>-1?"Android":e.indexOf("iOS")>-1||e.indexOf("iPhone")>-1||e.indexOf("iPad")>-1?"iOS":"Unknown"},_refreshVisibleState:function(){this.collectionState.visibilityChangeCount>1&&this._collectResources()},_setupCoreWebVitals:function(){t(this)},_setupBufferManagement:function(){this.bufferManager.setupBufferManagement()},_shouldCollectResource:function(e){return this.bufferManager.shouldCollectResource(e)},_startBatchProcessing:function(){this.bufferManager.startBatchProcessing()},_flushBuffers:function(e,t=!1){this._prepareFinalDataAndSend(t)},_flushEvents:function(e=!1){this._prepareFinalDataAndSend(e)},_flushResources:function(e=!1){this._prepareFinalDataAndSend(e)},_flushWebVitals:function(e=!1){this._updateWebVitalsInUnifiedModel(),this._prepareFinalDataAndSend(e)},_setupEventListeners:function(){n(this)},_setupPerformanceObservers:function(){this._setupCoreWebVitals(),this._setupAjaxMonitoring(),this.captureResourceData("setup")},captureResourceData:function(e="manual"){return this._collectResources(),!0},_sendResourceBatch:function(e){return e&&e.length>0&&(this.unifiedDataModel.resources=[...this.unifiedDataModel.resources,...e]),!0},createSession:function(){return o(this)},_sendToServer:function(e,t,n={}){return(function(e,t,n,i,a={}){const s=e+t,o={method:"POST",headers:{"Content-Type":"application/json","x-api-key":i},body:JSON.stringify(n)};if(a.sync&&navigator.sendBeacon){const e=new Blob([JSON.stringify(n)],{type:"application/json"}),t=navigator.sendBeacon(s,e);return Promise.resolve(t)}return fetch(s,o).then((e=>{if(!e.ok)throw Error("Server responded with status: "+e.status);return e.json()})).then((e=>!0)).catch((e=>!1))})(this.endpoint,e,t,this.apiKey,n)},sendEvent:function(e,t,n={}){if(!this.sessionId)return!1;const i={session_id:this.sessionId,event_type:e,event_data:t||{},timestamp:Date.now()};return"core_web_vital"===e?(this.buffer.webVitals.push(i),!0===n.immediate&&this._updateWebVitalsInUnifiedModel()):this.buffer.events.push(i),!0},collectPerformanceMetrics:function(){return this._collectResources(),this._updateWebVitalsInUnifiedModel(),!0},sendCollectedData:function(e=!1){return this._prepareFinalDataAndSend(e),!0},debug:function(){return{sessionId:this.sessionId,apiKey:this.apiKey?this.apiKey.substring(0,4)+"...":"None",endpoint:this.endpoint,bufferState:{events:this.buffer.events.length,resources:this.buffer.resources.length,webVitals:this.buffer.webVitals.length},collectionState:{pageLoaded:this.collectionState.pageLoaded,interactionCount:this.collectionState.interactionCount,lastResourceFlush:new Date(this.collectionState.lastResourceFlush).toISOString(),lastEventFlush:new Date(this.collectionState.lastEventFlush).toISOString(),resourceHashMapSize:Object.keys(this.collectionState.resourceHashMap).length,lastVisibilityChange:new Date(this.collectionState.lastVisibilityChange).toISOString(),visibilityState:this.collectionState.visibilityState,sentResourceURLsCount:this.collectionState.sentResourceURLs.size},configuration:this.batchConfig,resourceCaptureResult:this.captureResourceData("debug")}},_setupAjaxMonitoring:function(){i(this)},_flushAjaxCalls:function(e=!1){this.flushManager.flushAjaxCalls(e)}},e.Optima=a,"function"==typeof e.optima){var l=e.optima;if(e.optima=r,l.q&&l.q.length)for(var c=0;l.q.length>c;c++)r.apply(e,l.q[c])}else e.optima=r})(window)})();
