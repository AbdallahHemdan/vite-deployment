!(function(){"use strict";function t(){const t=navigator.userAgent;return/(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(t)?"tablet":/Mobile|Android|iP(hone|od)|IEMobile|BlackBerry|Kindle|Silk-Accelerated|(hpw|web)OS|Opera M(obi|ini)/.test(t)?"mobile":"desktop"}function e(t){try{"PerformanceObserver"in window&&((function(t){let e=0;new PerformanceObserver((i=>{const n=i.getEntries(),s=n[n.length-1];if(window.performance.mark("optima_lcp"),window.performance.measure("optima_lcp_time","navigationStart","optima_lcp"),s.startTime>e){e=s.startTime;const i=s.element?{tagName:s.element.tagName,id:s.element.id||null,className:s.element.className||null,size:s.size,dimensions:s.element.getBoundingClientRect?{width:Math.round(s.element.getBoundingClientRect().width),height:Math.round(s.element.getBoundingClientRect().height)}:null}:"unknown";t.sendEvent("core_web_vital",{name:"LCP",value:s.startTime,element:i}),t.unifiedDataModel.web_vitals.LCP={value:s.startTime,timestamp:performance.timeOrigin+s.startTime,element:i},n.length>1||setTimeout((()=>{t.buffer.webVitals.length>0&&t.t()}),1e3)}})).observe({type:"largest-contentful-paint",buffered:!0})})(t),(function(t){new PerformanceObserver((e=>{const i=e.getEntries()[0];window.performance.mark("optima_fid");const n={type:i.name,targetElement:i.target?{tagName:i.target.tagName,id:i.target.id||null,className:i.target.className||null}:null,timing:{processingStart:i.processingStart,processingEnd:i.processingEnd,startTime:i.startTime}},s=i.processingStart-i.startTime;t.sendEvent("core_web_vital",{name:"FID",value:s,inputType:i.name,details:n},{immediate:!0}),t.unifiedDataModel.web_vitals.FID={value:s,timestamp:performance.timeOrigin+i.startTime,inputType:i.name,details:n}})).observe({type:"first-input",buffered:!0})})(t),(function(t){let e=0,i=[],n=[],s=0,o=performance.now(),a=0;document.addEventListener("visibilitychange",(()=>{"hidden"===document.visibilityState?a>0&&(t.unifiedDataModel.web_vitals.CLS={value:a,timestamp:Date.now(),entries:n.length}):"visible"===document.visibilityState&&performance.now()-o>1e3&&(o=performance.now(),a=0,n=[])})),new PerformanceObserver((o=>{o.getEntries().forEach((t=>{t.hadRecentInput||(e+=t.value,i.push(t),a+=t.value,n.push({value:t.value,startTime:t.startTime}))}));const r=Date.now();(r-s>5e3||i.length%10==0)&&i.length>0&&(s=r,t.sendEvent("core_web_vital",{name:"CLS",value:e,entries:i.length,sessionValue:a,sessionEntries:n.length}),t.unifiedDataModel.web_vitals.CLS={value:e,timestamp:r,entries:i.length,sessionValue:a,sessionEntries:n.length},i.length%30==0&&setTimeout((()=>{t.buffer.webVitals.length>0&&t.t()}),1e3))})).observe({type:"layout-shift",buffered:!0})})(t),(function(t){if(!window.PerformanceObserver||!window.PerformanceObserver.supportedEntryTypes||!window.PerformanceObserver.supportedEntryTypes.includes("event"))return;let e=0;const i=new PerformanceObserver((i=>{i.getEntries().forEach((i=>{if(!["pointerdown","keydown","click","mousedown","touchstart"].includes(i.name))return;const n=i.processingEnd-i.startTime,s={name:i.name,startTime:i.startTime,processingStart:i.processingStart,processingEnd:i.processingEnd,duration:n,renderTime:i.renderTime||null,interactionId:i.interactionId||null,targetElement:i.target?{tagName:i.target.tagName,id:i.target.id||null,className:i.target.className||null}:null};n>e&&(e=n,t.sendEvent("core_web_vital",{name:"INP",value:n,interaction:s}),t.unifiedDataModel.web_vitals.INP={value:n,timestamp:performance.timeOrigin+i.startTime,interaction:s})}))}));try{i.observe({type:"event",buffered:!0,durationThreshold:16})}catch(t){}})(t),(function(t){document.addEventListener("visibilitychange",(function(){"hidden"===document.visibilityState&&t.buffer.webVitals.length>0&&t.i(!0)})),window.addEventListener("beforeunload",(function(){t.buffer.webVitals.length>0&&t.i(!0)}))})(t),(function(t){if(!window.PerformanceObserver||!window.PerformanceObserver.supportedEntryTypes||!window.PerformanceObserver.supportedEntryTypes.includes("longtask"))return;let e=[];const i=new PerformanceObserver((i=>{i.getEntries().forEach((t=>{e.push({startTime:t.startTime,duration:t.duration,attribution:t.attribution?.length?{name:t.attribution[0].name,containerType:t.attribution[0].containerType,containerName:t.attribution[0].containerName,containerId:t.attribution[0].containerId}:null})})),5>e.length||(t.unifiedDataModel.metrics.longTasks=e,e=[])}));try{i.observe({type:"longtask",buffered:!0})}catch(t){}})(t))}catch(t){}}function i(t){if(!t.sessionId)return;"complete"===document.readyState?t.collectionState.pageLoaded||(t.collectionState.pageLoaded=!0,setTimeout((()=>{t.captureResourceData("load"),t.sendEvent("page_view",{url:window.location.href,title:document.title,referrer:document.referrer})}),1e3)):window.addEventListener("load",(()=>{t.collectionState.pageLoaded||(t.collectionState.pageLoaded=!0,setTimeout((()=>{t.captureResourceData("load"),t.sendEvent("page_view",{url:window.location.href,title:document.title,referrer:document.referrer})}),1e3))}));let e=null;if(document.addEventListener("click",(i=>{let n=i.target,s="";if("A"===n.tagName||n.closest("a")){const e="A"===n.tagName?n:n.closest("a");s="link",t.sendEvent("user_interaction",{type:"click",element_type:s,element_id:e.id||null,element_class:e.className||null,element_text:e.textContent?.trim()||null,element_href:e.href||null})}else if("BUTTON"===n.tagName||n.closest("button")){const e="BUTTON"===n.tagName?n:n.closest("button");s="button",t.sendEvent("user_interaction",{type:"click",element_type:s,element_id:e.id||null,element_class:e.className||null,element_text:e.textContent?.trim()||null})}e&&clearTimeout(e),e=setTimeout((()=>{t.captureResourceData("interaction"),e=null}),2e3)})),"requestIdleCallback"in window){let e=!1;window.requestIdleCallback((()=>{e||(e=!0,t.captureResourceData("idle"),t.sendEvent("page_ready",{url:window.location.href,title:document.title,time_to_idle:performance.now()}))}),{timeout:3e3})}document.addEventListener("visibilitychange",(()=>{"visible"===document.visibilityState?t.sendEvent("visibility_change",{state:"visible",timestamp:Date.now()}):"hidden"===document.visibilityState&&t.sendEvent("visibility_change",{state:"hidden",timestamp:Date.now()},{immediate:!0})}))}function n(t){t.buffer.ajaxCalls||(t.buffer.ajaxCalls=[]),t.buffer.preSessionAjaxCalls||(t.buffer.preSessionAjaxCalls=[]),(function(t){const e=XMLHttpRequest.prototype.open,i=XMLHttpRequest.prototype.send;function n(t,e){if(t.o&&!(t.o.url.includes("/api/sessions")||t.o.url.includes("/api/events")||t.o.url.includes("/api/resources")||t.o.url.includes("/api/web-vitals")||t.o.url.includes("/api/ajax-calls"))){t.o.duration=Date.now()-t.o.startTime,t.o.errored||t.o.aborted||(t.o.status=t.status,t.o.statusText=t.statusText);try{const e=t.getAllResponseHeaders();e&&e.trim().split(/[\r\n]+/).forEach((e=>{const i=e.split(": "),n=i.shift(),s=i.join(": ");t.o.responseHeaders[n.toLowerCase()]=s}))}catch(t){}if(""===t.responseType||"text"===t.responseType)t.o.responseSize=t.responseText?t.responseText.length:0;else if("blob"===t.responseType)t.o.responseSize=t.response?t.response.size:0;else if("arraybuffer"===t.responseType)t.o.responseSize=t.response?t.response.byteLength:0;else if("json"===t.responseType)try{t.o.responseSize=t.response?JSON.stringify(t.response).length:0}catch(e){t.o.responseSize=-1}else t.o.responseSize=-1;if(window.performance&&window.performance.getEntriesByType){const e=window.performance.getEntriesByType("resource"),i=t.o.url.split("?")[0],n=e.find((t=>t.name.indexOf(i)>=0&&("xmlhttprequest"===t.initiatorType||"fetch"===t.initiatorType)));n&&(t.o.resourceTiming={startTime:Math.round(n.startTime),duration:Math.round(n.duration),domainLookupTime:Math.round(n.domainLookupEnd-n.domainLookupStart),connectTime:Math.round(n.connectEnd-n.connectStart),tlsTime:n.secureConnectionStart?Math.round(n.connectEnd-n.secureConnectionStart):0,requestStartTime:Math.round(n.requestStart),ttfb:Math.round(n.responseStart-n.requestStart),downloadTime:Math.round(n.responseEnd-n.responseStart)})}s(e,{type:"xhr",method:t.o.method,url:t.o.url,status:t.o.status,statusText:t.o.statusText,startTime:t.o.startTime,duration:t.o.duration,async:t.o.async,requestPayloadSize:t.o.requestPayloadSize,responseSize:t.o.responseSize,aborted:t.o.aborted,errored:t.o.errored,timedOut:t.o.timedOut,timestamp:Date.now(),resourceTiming:t.o.resourceTiming||null,requestHeaders:{"content-type":t.o.sentHeaders["content-type"]||"unknown","content-length":t.o.sentHeaders["content-length"]||"unknown"},responseHeaders:{"content-type":t.o.responseHeaders["content-type"]||"unknown","content-length":t.o.responseHeaders["content-length"]||"unknown","cache-control":t.o.responseHeaders["cache-control"]||"unknown"}})}}XMLHttpRequest.prototype.open=function(t,i,n,s,o){return this.o={method:t,url:i,startTime:Date.now(),async:!1!==n,status:0,statusText:"",sentHeaders:{},responseHeaders:{},responseSize:0,duration:0,aborted:!1,errored:!1},e.apply(this,arguments)},XMLHttpRequest.prototype.send=function(e){if(this.o||(this.o={method:"unknown",url:"unknown",startTime:Date.now(),async:!0,status:0,statusText:"",sentHeaders:{},responseHeaders:{},responseSize:0,duration:0,aborted:!1,errored:!1}),e)try{this.o.requestPayloadSize="string"==typeof e?e.length:e instanceof FormData?-1:e instanceof Blob?e.size:e instanceof ArrayBuffer?e.byteLength:JSON.stringify(e).length}catch(t){this.o.requestPayloadSize=-1}else this.o.requestPayloadSize=0;try{if(this.getAllRequestHeaders){const t=this.getAllRequestHeaders();t&&t.trim().split(/[\r\n]+/).forEach((t=>{const e=t.split(": "),i=e.shift(),n=e.join(": ");this.o.sentHeaders[i.toLowerCase()]=n}))}}catch(t){}const s=this;return s.addEventListener("load",(function(){n(s,t)})),s.addEventListener("error",(function(){s.o.errored=!0,s.o.status=0,s.o.statusText="Network Error",n(s,t)})),s.addEventListener("abort",(function(){s.o.aborted=!0,n(s,t)})),s.addEventListener("timeout",(function(){s.o.timedOut=!0,n(s,t)})),i.apply(this,arguments)}})(t),(function(t){if("function"!=typeof window.fetch)return;const e=window.fetch;window.fetch=function(i,n){const o=Date.now()+Math.random().toString(36).substring(2,9);let a,r,c={};if("string"==typeof i?a=i:i instanceof Request&&(a=i.url,r=i.method),n&&(r=n.method||"GET",n.headers))if(n.headers instanceof Headers)try{for(let t of n.headers.entries())c[t[0].toLowerCase()]=t[1]}catch(t){}else"object"==typeof n.headers&&Object.keys(n.headers).forEach((t=>{c[t.toLowerCase()]=n.headers[t]}));if(r=r||"GET",a.includes("/api/sessions")||a.includes("/api/events")||a.includes("/api/resources")||a.includes("/api/web-vitals")||a.includes("/api/ajax-calls"))return e.apply(this,arguments);const u=Date.now(),l={type:"fetch",id:o,method:r,url:a,status:0,statusText:"",startTime:u,duration:0,requestPayloadSize:-1,responseSize:-1,aborted:!1,errored:!1,timestamp:u,resourceTiming:null,requestHeaders:{"content-type":c["content-type"]||"unknown","content-length":c["content-length"]||"unknown"},responseHeaders:{}};if(n&&n.body)try{l.requestPayloadSize="string"==typeof n.body?n.body.length:n.body instanceof FormData?-1:n.body instanceof Blob?n.body.size:n.body instanceof ArrayBuffer?n.body.byteLength:JSON.stringify(n.body).length}catch(t){l.requestPayloadSize=-1}const h=e.apply(this,arguments);return h.then((e=>{const i=Date.now();l.duration=i-u,l.status=e.status,l.statusText=e.statusText;try{e.headers&&(l.responseHeaders={"content-type":e.headers.get("content-type")||"unknown","content-length":e.headers.get("content-length")||"unknown","cache-control":e.headers.get("cache-control")||"unknown"})}catch(t){}const n=e.headers.get("content-length");return n&&(l.responseSize=parseInt(n,10)),e.clone().text().then((e=>{if(0>l.responseSize&&(l.responseSize=e.length),window.performance&&window.performance.getEntriesByType){const t=window.performance.getEntriesByType("resource"),e=l.url.split("?")[0],i=t.find((t=>t.name.indexOf(e)>=0&&("fetch"===t.initiatorType||"xmlhttprequest"===t.initiatorType)));i&&(l.resourceTiming={startTime:Math.round(i.startTime),duration:Math.round(i.duration),domainLookupTime:Math.round(i.domainLookupEnd-i.domainLookupStart),connectTime:Math.round(i.connectEnd-i.connectStart),tlsTime:i.secureConnectionStart?Math.round(i.connectEnd-i.secureConnectionStart):0,requestStartTime:Math.round(i.requestStart),ttfb:Math.round(i.responseStart-i.requestStart),downloadTime:Math.round(i.responseEnd-i.responseStart)})}s(t,l)})).catch((t=>{}))})).catch((e=>{const i=Date.now();l.duration=i-u,l.errored=!0,l.errorMessage=e.message||"Network error",s(t,l)})),h}})(t)}function s(t,e){t.sessionId?(t.buffer.ajaxCalls.push(e),t.batchConfig.maxAjaxCallsPerBatch>t.buffer.ajaxCalls.length||t.u()):t.buffer.preSessionAjaxCalls.push(e)}function o(t){return{setupBufferManagement(){setInterval((()=>{this.trimBuffers()}),3e4)},trimBuffers(){const e=t.batchConfig.maxBufferSize;t.buffer.events.length>e&&(t.buffer.events=t.buffer.events.slice(-e)),t.buffer.resources.length>e&&(t.buffer.resources=t.buffer.resources.slice(-e)),t.buffer.webVitals.length>e&&(t.buffer.webVitals=t.buffer.webVitals.slice(-e))},hashResource(t){return`${t.type}|${t.name.split("?")[0]}|${50>t.duration?"fast":"slow"}`},shouldCollectResource(e){if(t.batchConfig.resourceDedupingEnabled){const i=this.hashResource(e);if(t.collectionState.resourceHashMap[i])return!1;t.collectionState.resourceHashMap[i]=Date.now()}return!0},startBatchProcessing(){if(setInterval((()=>{t.buffer.events.length>0&&t.l(),t.buffer.webVitals.length>0&&t.h(),t.buffer.resources.length>0&&t.m()}),Math.min(t.batchConfig.flushInterval,1e4)),t.batchConfig.visibilityFlushEnabled&&document.addEventListener("visibilitychange",(()=>{const e=Date.now(),i=document.visibilityState;t.collectionState.visibilityState=i,e-t.collectionState.lastVisibilityChange>1e3&&(t.collectionState.lastVisibilityChange=e,"hidden"===i?t.p("visibilityHidden",!0):"visible"===i&&setTimeout((()=>{t.captureResourceData("visibilityVisible")}),1e3))})),window.addEventListener("beforeunload",(()=>{t.p("unload",!0)})),t.batchConfig.flushAtIdle&&"requestIdleCallback"in window){const e=()=>{window.requestIdleCallback((()=>{(t.buffer.events.length>=10||t.buffer.resources.length>=10||Date.now()-t.collectionState.lastResourceFlush>3e4)&&t.p("idle"),setTimeout((()=>{e()}),2e4)}),{timeout:1e4})};e()}this.setupBufferManagement()}}}function a(e){const i=Date.now().toString(36);e.sessionId=`${i}-${"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){var e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)}))}`;const n=window.performance&&window.performance.timing?window.performance.timing:{},s={session_id:e.sessionId,page_url:window.location.href,navigation_start:n.navigationStart||Date.now(),timestamp:Date.now(),user_agent:navigator.userAgent,device_type:t(),connection_type:navigator.connection&&navigator.connection.effectiveType||"unknown",referrer:document.referrer||"",resources:[],meta:{pathname:window.location.pathname,page_title:document.title,navigation_type:window.performance&&window.performance.getEntriesByType&&window.performance.getEntriesByType("navigation")[0]?.type||"unknown",screen_width:window.screen.width,screen_height:window.screen.height,device_speed:navigator.hardwareConcurrency||null,browser:(()=>{const t=navigator.userAgent;return/chrome|crios|crmo/i.test(t)?"Chrome":/firefox|fxios/i.test(t)?"Firefox":/safari/i.test(t)&&!/chrome|crios|crmo/i.test(t)?"Safari":/edg/i.test(t)?"Edge":/opr\//i.test(t)?"Opera":"Unknown"})(),os:(()=>{const t=navigator.userAgent;return/windows nt/i.test(t)?"Windows":/mac os x/i.test(t)?"Mac OS":/android/i.test(t)?"Android":/iphone|ipad|ipod/i.test(t)?"iOS":/linux/i.test(t)?"Linux":"Unknown"})(),connection_downlink:navigator.connection?.downlink||null,connection_rtt:navigator.connection?.rtt||null}};return(function(t){t.buffer.preSessionAjaxCalls&&t.buffer.preSessionAjaxCalls.length&&(t.buffer.ajaxCalls.push(...t.buffer.preSessionAjaxCalls),t.buffer.preSessionAjaxCalls=[])})(e),e.v("/api/sessions",s).then((t=>{t&&(e._(),e.T(),e.S(),e.sessionStartTime=Date.now(),e.unifiedDataModel.session_id=e.sessionId,e.unifiedDataModel.timestamp=e.sessionStartTime)})),e.sessionId}!(function(t){function s(t){var e;this.apiKey=(t=t||{}).apiKey,this.endpoint=t.endpoint||"http://localhost:3000",this.sessionId=null,this.sessionStartTime=null,this.buffer={events:[],resources:[],webVitals:[],ajaxCalls:[]},this.unifiedDataModel={session_id:null,timestamp:null,web_vitals:{LCP:null,FID:null,CLS:null,TTFB:null,INP:null},resources:[],ajax_requests:[],errors:[],timings:null,metrics:{},meta:{}},this.batchConfig={maxEventsPerBatch:50,maxResourcesPerBatch:50,maxWebVitalsPerBatch:20,maxAjaxCallsPerBatch:50,flushInterval:t.flushInterval||5e3,webVitalsBatchDelay:t.webVitalsBatchDelay||2e3,batchBeforeSend:t.batchBeforeSend||!0,payloadCompressionThreshold:10240},this.collectionState={isFirstLoad:!0,resourcesCollected:!1,lastResourceFlush:null,lastEventFlush:null,lastAjaxCallFlush:null,isPerformanceObserverSet:!1,isBatchProcessingStarted:!1,unloadSent:!1,visibilityChangeCount:0},this.bufferManager=o(this),this.flushManager=(e=this,{flushBuffers(t,i=!1){e.buffer.events.length>0&&this.flushEvents(i),e.buffer.resources.length>0&&this.flushResources(i),e.buffer.webVitals.length>0&&this.flushWebVitals(i),e.buffer.ajaxCalls&&e.buffer.ajaxCalls.length>0&&this.flushAjaxCalls(i)},flushEvents(t=!1){if(0===e.buffer.events.length)return;const i=e.buffer.events.slice(0,e.batchConfig.maxEventsPerBatch);e.buffer.events=e.buffer.events.slice(e.batchConfig.maxEventsPerBatch);const n={session_id:e.sessionId,events:i,timestamp:Date.now(),count:i.length};e.collectionState.lastEventFlush=Date.now(),e.v("/api/events",n,{sync:t})},flushResources(t=!1){if(0===e.buffer.resources.length)return;const i=e.buffer.resources.slice(0,e.batchConfig.maxResourcesPerBatch);e.buffer.resources=e.buffer.resources.slice(e.batchConfig.maxResourcesPerBatch);const n={session_id:e.sessionId,resources:i,timestamp:Date.now(),count:i.length};e.collectionState.lastResourceFlush=Date.now(),e.v("/api/resources",n,{sync:t})},flushWebVitals(t=!1){if(0===e.buffer.webVitals.length)return;const i=e.buffer.webVitals.slice(0,e.batchConfig.maxWebVitalsPerBatch);e.buffer.webVitals=e.buffer.webVitals.slice(e.batchConfig.maxWebVitalsPerBatch);const n=i.reduce(((t,e)=>{if(!e.event_data||!e.event_data.name)return t;const i=e.event_data.name,n=e.event_data.value;return t[i]=t[i]||[],t[i].push({value:n,timestamp:e.timestamp,...e.event_data}),t}),{}),s={session_id:e.sessionId,web_vitals:i,processed_vitals:n,timestamp:Date.now(),count:i.length},o=t||"hidden"===document.visibilityState;e.v("/api/web-vitals",s,{sync:o}),e.batchConfig.maxWebVitalsPerBatch/2>e.buffer.webVitals.length||setTimeout((()=>{this.flushWebVitals(t)}),1e3)},flushAjaxCalls(t=!1){if(!e.buffer.ajaxCalls||0===e.buffer.ajaxCalls.length)return;const i=e.buffer.ajaxCalls.slice(0,e.batchConfig.maxAjaxCallsPerBatch);e.buffer.ajaxCalls=e.buffer.ajaxCalls.slice(e.batchConfig.maxAjaxCallsPerBatch);const n={session_id:e.sessionId,ajax_calls:i,timestamp:Date.now(),count:i.length};e.collectionState.lastAjaxCallFlush=Date.now(),e.v("/api/ajax-calls",n,{sync:t})}}),this.k(),this.D=null,this.M()}function r(){var e=[].slice.call(arguments),i=e[0];if("init"===i){var n=e[2]||{};return n.apiKey=e[1]||null,t.optimaInstance=new s(n),t.optimaInstance}if(!t.optimaInstance)return!1;switch(i){case"event":return t.optimaInstance.sendEvent(e[1],e[2],e[3]);case"captureResources":return t.optimaInstance.captureResourceData("manual");case"flushBuffers":return t.optimaInstance.sendCollectedData(!0===e[1]);case"debug":return t.optimaInstance.debug();default:return!1}}if(s.prototype={M(){this.apiKey&&(this.C(),this.P(),this.createSession(),this.O())},C(){if(t.performance&&t.performance.mark){t.performance.mark("optima_init");try{t.performance.getEntriesByType("mark").concat(t.performance.getEntriesByType("measure")).filter((t=>t.name.startsWith("optima_"))).forEach((e=>{t.performance.clearMarks(e.name),"measure"===e.entryType&&t.performance.clearMeasures(e.name)}))}catch(t){}this.B(),this.L()}},L(){try{const t=performance.getEntriesByType("navigation")[0];t&&(this.unifiedDataModel.timings={navigationStart:0,fetchStart:t.fetchStart,domainLookupStart:t.domainLookupStart,domainLookupEnd:t.domainLookupEnd,connectStart:t.connectStart,connectEnd:t.connectEnd,requestStart:t.requestStart,responseStart:t.responseStart,responseEnd:t.responseEnd,domInteractive:t.domInteractive,domContentLoadedEventStart:t.domContentLoadedEventStart,domContentLoadedEventEnd:t.domContentLoadedEventEnd,domComplete:t.domComplete,loadEventStart:t.loadEventStart,loadEventEnd:t.loadEventEnd,duration:t.duration,type:t.type,redirectCount:t.redirectCount,nextHopProtocol:t.nextHopProtocol},this.unifiedDataModel.web_vitals.TTFB={value:t.responseStart,timestamp:performance.timeOrigin+t.responseStart},this.sendEvent("core_web_vital",{name:"TTFB",value:t.responseStart},{immediate:!0}))}catch(t){}},O(){document.addEventListener("visibilitychange",(()=>{this.collectionState.visibilityChangeCount++,"hidden"===document.visibilityState?this.i(!0):"visible"===document.visibilityState&&this.I()})),t.addEventListener("beforeunload",(()=>{this.collectionState.unloadSent||(this.i(!0),this.collectionState.unloadSent=!0)})),this.N()},i(t=!1){this.R(),this.t(),this.j(t)},t(){this.buffer.webVitals.forEach((t=>{if(!t.event_data||!t.event_data.name)return;const{name:e,value:i}=t.event_data,n=t.timestamp;"LCP"===e?this.unifiedDataModel.web_vitals.LCP&&this.unifiedDataModel.web_vitals.LCP.value>=i||(this.unifiedDataModel.web_vitals.LCP={value:i,timestamp:n,element:t.event_data.element||"unknown"}):"FID"===e?this.unifiedDataModel.web_vitals.FID||(this.unifiedDataModel.web_vitals.FID={value:i,timestamp:n,inputType:t.event_data.inputType}):"CLS"===e?this.unifiedDataModel.web_vitals.CLS&&this.unifiedDataModel.web_vitals.CLS.value>=i||(this.unifiedDataModel.web_vitals.CLS={value:i,timestamp:n,entries:t.event_data.entries}):"INP"===e&&(this.unifiedDataModel.web_vitals.INP&&this.unifiedDataModel.web_vitals.INP.value>=i||(this.unifiedDataModel.web_vitals.INP={value:i,timestamp:n,event:t.event_data.event}))})),this.buffer.webVitals=[]},R(){this.buffer.resources.length>0&&(this.unifiedDataModel.resources=[...this.unifiedDataModel.resources,...this.buffer.resources],this.buffer.resources=[]),this.buffer.ajaxCalls.length>0&&(this.unifiedDataModel.ajax_requests=[...this.unifiedDataModel.ajax_requests,...this.buffer.ajaxCalls],this.buffer.ajaxCalls=[]),this.buffer.events=[],this.unifiedDataModel.session_id=this.sessionId,this.unifiedDataModel.timestamp=Date.now(),this.F()},F(){this.unifiedDataModel.meta={url:t.location.href,path:t.location.pathname,referrer:document.referrer,title:document.title,user_agent:navigator.userAgent,screen_width:t.screen.width,screen_height:t.screen.height,viewport_width:t.innerWidth,viewport_height:t.innerHeight,connection_type:navigator.connection?navigator.connection.effectiveType:null,connection_downlink:navigator.connection?navigator.connection.downlink:null,connection_rtt:navigator.connection?navigator.connection.rtt:null,device_memory:navigator.deviceMemory,device_speed:navigator.hardwareConcurrency,page_visibility:document.visibilityState,visibility_changes:this.collectionState.visibilityChangeCount,timestamp:Date.now(),browser:this.H(),os:this.A(),navigation_type:performance.getEntriesByType("navigation")[0]?.type||null}},j(t=!1){if(!this.unifiedDataModel.session_id)return;const e=JSON.parse(JSON.stringify(this.unifiedDataModel));this.v("/api/collect",e,{sync:t}),this.V()},V(){this.unifiedDataModel.resources=[],this.unifiedDataModel.ajax_requests=[]},k(){this.collectionState.isBatchProcessingStarted||(this.collectionState.isBatchProcessingStarted=!0,this.$())},$(){setInterval((()=>{this.U()}),3e3),this.N()},N(){setInterval((()=>{this.W()&&this.i(!1)}),this.batchConfig.flushInterval)},W(){return this.unifiedDataModel.resources.length>0||this.unifiedDataModel.ajax_requests.length>0||this.buffer.webVitals.length>0||this.unifiedDataModel.web_vitals.LCP&&this.unifiedDataModel.web_vitals.LCP.value||this.unifiedDataModel.web_vitals.FID&&this.unifiedDataModel.web_vitals.FID.value||this.unifiedDataModel.web_vitals.CLS&&this.unifiedDataModel.web_vitals.CLS.value},U(){try{performance.getEntriesByType("resource").forEach((t=>{if(this.J(t.name))return;const e={name:t.name,type:this.X(t),startTime:Math.round(t.startTime),duration:Math.round(t.duration),size:t.transferSize||0,protocol:t.nextHopProtocol,encodedSize:t.encodedBodySize||0,decodedSize:t.decodedBodySize||0,initiatorType:t.initiatorType};this.unifiedDataModel.resources.push(e)})),this.collectionState.resourcesCollected=!0}catch(t){}},J(t){return this.unifiedDataModel.resources.some((e=>e.name===t))},X(t){const e=t.initiatorType,i=t.name;return"img"===e||"image"===e?"image":"script"===e?"script":"link"===e&&t.nextHopProtocol||"css"===e?"stylesheet":"fetch"===e||"xmlhttprequest"===e?"xhr":/\.(?:png|jpg|jpeg|gif|webp|svg|ico)(?:\?|$)/i.test(i)?"image":/\.(?:js)(?:\?|$)/i.test(i)?"script":/\.(?:css)(?:\?|$)/i.test(i)?"stylesheet":/\.(?:woff2?|ttf|otf|eot)(?:\?|$)/i.test(i)?"font":/\.(?:mp4|webm|ogv)(?:\?|$)/i.test(i)?"video":/\.(?:mp3|ogg|wav)(?:\?|$)/i.test(i)?"audio":"other"},H(){const t=navigator.userAgent;return t.indexOf("Chrome")>-1?"Chrome":t.indexOf("Safari")>-1?"Safari":t.indexOf("Firefox")>-1?"Firefox":t.indexOf("MSIE")>-1||t.indexOf("Trident/")>-1?"IE":t.indexOf("Edge")>-1?"Edge":t.indexOf("Opera")>-1||t.indexOf("OPR/")>-1?"Opera":"Unknown"},A(){const t=navigator.userAgent;return t.indexOf("Win")>-1?"Windows":t.indexOf("Mac")>-1?"Mac OS":t.indexOf("Linux")>-1?"Linux":t.indexOf("Android")>-1?"Android":t.indexOf("iOS")>-1||t.indexOf("iPhone")>-1||t.indexOf("iPad")>-1?"iOS":"Unknown"},I(){this.collectionState.visibilityChangeCount>1&&this.U()},B(){e(this)},G(){this.bufferManager.setupBufferManagement()},K(t){return this.bufferManager.shouldCollectResource(t)},S(){this.bufferManager.startBatchProcessing()},p(t,e=!1){this.i(e)},l(t=!1){this.i(t)},m(t=!1){this.i(t)},h(t=!1){this.t(),this.i(t)},_(){i(this)},T(){this.B(),this.P(),this.captureResourceData("setup")},captureResourceData(t="manual"){return this.U(),!0},Y(t){return t&&t.length>0&&(this.unifiedDataModel.resources=[...this.unifiedDataModel.resources,...t]),!0},createSession(){return a(this)},v(t,e,i={}){return(function(t,e,i,n,s={}){const o=t+e,a={method:"POST",headers:{"Content-Type":"application/json","x-api-key":n},body:JSON.stringify(i)};if(s.sync&&navigator.sendBeacon){const t=new Blob([JSON.stringify(i)],{type:"application/json"}),e=navigator.sendBeacon(o,t);return Promise.resolve(e)}return fetch(o,a).then((t=>{if(!t.ok)throw Error("Server responded with status: "+t.status);return t.json()})).then((t=>!0)).catch((t=>!1))})(this.endpoint,t,e,this.apiKey,i)},sendEvent(t,e,i={}){if(!this.sessionId)return!1;const n={session_id:this.sessionId,event_type:t,event_data:e||{},timestamp:Date.now()};return"core_web_vital"===t?(this.buffer.webVitals.push(n),!0===i.immediate&&this.t()):this.buffer.events.push(n),!0},collectPerformanceMetrics(){return this.U(),this.t(),!0},sendCollectedData(t=!1){return this.i(t),!0},debug(){return{sessionId:this.sessionId,apiKey:this.apiKey?this.apiKey.substring(0,4)+"...":"None",endpoint:this.endpoint,bufferState:{events:this.buffer.events.length,resources:this.buffer.resources.length,webVitals:this.buffer.webVitals.length},collectionState:{pageLoaded:this.collectionState.pageLoaded,interactionCount:this.collectionState.interactionCount,lastResourceFlush:new Date(this.collectionState.lastResourceFlush).toISOString(),lastEventFlush:new Date(this.collectionState.lastEventFlush).toISOString(),resourceHashMapSize:Object.keys(this.collectionState.resourceHashMap).length,lastVisibilityChange:new Date(this.collectionState.lastVisibilityChange).toISOString(),visibilityState:this.collectionState.visibilityState,sentResourceURLsCount:this.collectionState.sentResourceURLs.size},configuration:this.batchConfig,resourceCaptureResult:this.captureResourceData("debug")}},P(){n(this)},u(t=!1){this.flushManager.flushAjaxCalls(t)}},t.Optima=s,"function"==typeof t.optima){var c=t.optima;if(t.optima=r,c.q&&c.q.length)for(var u=0;c.q.length>u;u++)r.apply(t,c.q[u])}else t.optima=r})(window)})();
